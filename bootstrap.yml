---
- name: Bootstrap Debian server
  hosts: lillyhost01
  become: true
  vars:
    tailscale_authkey: ""  # Provide via --extra-vars or Vault

  roles:
    - geerlingguy.docker
  
  tasks:
    - name: Set system timezone to UTC
      timezone:
        name: Etc/UTC

    - name: Enable NTP sync
      systemd:
        name: systemd-timesyncd
        enabled: yes
        state: started

    - name: Update & upgrade system
      apt:
        upgrade: dist
        update_cache: yes
        autoremove: yes
        autoclean: yes

    - name: Ensure Tailscale dependencies are present
      apt:
        name:
          - iptables
          - iproute2
          - ca-certificates
          - curl
          - lsb-release
        state: present
        update_cache: yes

    - name: Ensure UFW is installed
      apt:
        name: ufw
        state: present
        update_cache: yes        

    - name: Reboot if needed
      reboot:
        pre_reboot_delay: 0
        reboot_timeout: 600
        post_reboot_delay: 30
        test_command: uptime

    - name: Install Tailscale
      shell: curl -fsSL https://tailscale.com/install.sh | sh
      args:
        creates: /usr/sbin/tailscaled
  
    - name: Reload systemd (ensure tailscaled is registered)
      command: systemctl daemon-reexec
      notify: Start Tailscaled

    - name: Enable Tailscale
      systemd:
        name: tailscaled
        enabled: yes
        state: started

    - name: Join tailnet if auth key provided
      shell: tailscale up --authkey {{ tailscale_authkey }} --ssh
      when: tailscale_authkey != ""

    - name: Enable UFW & allow SSH`
      ufw:
        rule: allow
        name: OpenSSH

    - name: Enable default UFW deny policy
      ufw:
        state: enabled
        policy: deny
    
    - name: Add ansibleadmin to docker group
      user:
        name: ansibleadmin
        groups: docker
        append: yes
    
    - name: Add rippee to docker group
      user:
        name: rippee
        groups: docker
        append: yes
  handlers:
    - name: Start Tailscaled
      systemd:
        name: tailscaled
        enabled: true
        state: started